                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
function[BlueTrials, UVTrials, GreenTrials, R,C]= main_Level2_meso_processing(outputPath,params,dFoF,dFoF_parcells,R,C)
fsspike2=params.fsspike2; 
fsimaging=params.fsimaging; 
fspupilcam=params.pupilSR; 
%% load preproceessed smrx output 
if params.visStimAn
   load(fullfile(tiffsPath, 'smrx_signals.mat'), 'timing', 'channels_data','timestamps','uniqContrasts','contrast_Idx');  
   %load(fullfile(tiffsPath, 'maxVisualTrace.mat'), 'maxVisSortedIdx');  
else
   load(fullfile(outputPath, 'smrx_signals.mat'), 'timing', 'channels_data','timestamps'); uniqContrasts=[];contrast_Idx=[];maxVisSortedIdx=[];
end 

%% load pupil camera output if proc file exists (facemap output)
files=dir(outputPath); 
fileflags=contains({files.name},'proc');
files=files(fileflags); 
if ~isempty(files), load(fullfile(outputPath, files.name)),else, proc=[];end 
pupilCamTimes=(timing.pupilcamstart+timing.pupilcamend)./2; 
%% get event triggered trials and movies for all events (visual stim, airpuff/electrical stim, locomotion onset)
Idx.Left_Vis_idx=2:2:16; %idx in parcells for left visual areas 
Idx.Right_Vis_idx=1:2:15;%right visual areas 
Idx.Left_Somat_idx=34:2:48; %idx in parcells for left somatosensory areas 
Idx.Right_Somat_idx=33:2:47;%right somatosensory areas 
Idx.Left_Frontal_idx=50:2:52; %idx in parcells left for frontal/motor areas (excluded prelimbic and cingulate because they are too small and along the midline)  
Idx.Right_Frontal_idx=49:2:51;%left frontal/motor areas 
%% analyze activity around events 
switch params.signalsExtraction.sigs
    case 'blueuv'
        [BlueTrials,~]=getTrialAllEvents(params,outputPath,'blue',dFoF,dFoF_parcells,timestamps,fsimaging,fsspike2,channels_data,Idx,uniqContrasts,contrast_Idx,maxVisSortedIdx,R,C,proc,pupilCamTimes,fspupilcam);
        save(fullfile(outputPath, 'BlueTrials.mat'), 'BlueTrials','R','C','-v7.3'); close all;
        
        [UVTrials,~]=getTrialAllEvents(params,outputPath,'uv',dFoF,dFoF_parcells,timestamps,fsimaging,fsspike2,channels_data,Idx,uniqContrasts,contrast_Idx,maxVisSortedIdx,R,C);
        save(fullfile(outputPath, 'UVTrials.mat'), 'UVTrials', 'R','C','-v7.3'); close all;
        GreenTrials=[];
        
    case 'RCaMP_AC'
        [BlueTrials,~]=getTrialAllEvents(params,outputPath,'blue',dFoF,dFoF_parcells,timestamps,fsimaging,fsspike2,channels_data,Idx,uniqContrasts,contrast_Idx,maxVisSortedIdx,R,C,proc,pupilCamTimes,fspupilcam);
        save(fullfile(outputPath, 'BlueTrials.mat'), 'BlueTrials', 'R','C','-v7.3');close all;

        [GreenTrials,~]=getTrialAllEvents(params,outputPath,'green',dFoF,dFoF_parcells,timestamps,fsimaging,fsspike2,channels_data,Idx,uniqContrasts,contrast_Idx,maxVisSortedIdx,R,C);
        save(fullfile(outputPath, 'GreenTrials.mat'), 'GreenTrials', 'R','C','-v7.3');close all;
      
        [UVTrials,~]=getTrialAllEvents(params,outputPath,'uv',dFoF,dFoF_parcells,timestamps,fsimaging,fsspike2,channels_data,Idx,uniqContrasts,contrast_Idx,maxVisSortedIdx,R,C,proc);
        save(fullfile(outputPath, 'UVTrials.mat'), 'UVTrials', 'R','C','-v7.3');close all; 
end 


